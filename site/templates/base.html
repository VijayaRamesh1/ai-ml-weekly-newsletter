<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>

  <!-- Editorial serif for masthead + modern UI font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:wght@600;700;800&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Light */
      --bg:#f7f7f5; --ink:#0e1726; --muted:#606b80;
      --panel:#ffffff; --rule:#d9dee7;
      --accent:#0e1726;        /* ink for rules/borders */
      --link:#0a5bd3;
      --container:1080px;
      --nav-h: 54px;           /* sticky category nav height */
    }
    [data-theme="dark"]{
      --bg:#0b0f17; --ink:#eaf1fa; --muted:#9fb0c8;
      --panel:#0f1522; --rule:#1b2638;
      --accent:#eaf1fa; --link:#9ac6ff;
    }

    html,body{height:100%}
    html{scroll-behavior:smooth} /* smooth anchor scroll */
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font: 16px/1.72 "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, "Noto Sans", sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .wrap{max-width:var(--container); margin:0 auto; padding:0 16px}

    /* ----- Masthead (centered, Nice News style) ----- */
    .mast{
      background:var(--bg);
      padding:18px 0 10px;
      border-bottom:1px solid var(--rule);
    }
    .mast .inner{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      margin:0; flex:1; text-align:center;
      font: 800 28px/1 "Newsreader", serif; letter-spacing:.5px;
    }
    .brand a{ color:var(--ink); text-decoration:none }
    .icon-btn, .subscribe{
      font:600 12px/1 "Inter"; letter-spacing:.08em; text-transform:uppercase;
      border:1.5px solid var(--accent); color:var(--ink);
      background:transparent; border-radius:8px; padding:8px 10px; cursor:pointer;
    }
    .left, .right{width:90px; display:flex; align-items:center}
    .left{justify-content:flex-start} .right{justify-content:flex-end}

    /* ----- Category nav (sticky, double rule) ----- */
    .cats{
      position:sticky; top:0; z-index:40;
      background:var(--bg);
      border-top:3px double var(--accent);
      border-bottom:1px solid var(--rule);
    }
    .cats .row{
      display:flex; gap:26px; overflow:auto; white-space:nowrap;
      align-items:center; justify-content:center; padding:12px 8px;
      text-transform:uppercase; letter-spacing:.10em; font:700 12px/1 "Inter";
    }
    .cats a{
      color:var(--ink); text-decoration:none; padding:6px 0; position:relative;
    }
    .cats a::after{
      content:""; position:absolute; left:0; right:0; bottom:-10px; height:3px;
      background:transparent; transition:background .15s ease;
    }
    .cats a:hover::after{ background:var(--ink) }
    .cats a.active{ color:var(--ink); }
    .cats a.active::after{ background:var(--ink) }

    /* ----- Controls (filters) ----- */
    .controls{
      position:sticky; top:calc(var(--nav-h) + 0px); z-index:30;
      background:var(--panel); border:1px solid var(--rule); border-radius:12px;
      padding:10px; margin:12px 0; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      box-shadow:0 1px 0 rgba(9,30,66,.04), 0 10px 28px rgba(9,30,66,.06);
    }
    /* clearer dropdowns */
    .controls select, .controls input[type="search"]{
      appearance:none; -webkit-appearance:none;
      background:var(--panel); color:var(--ink);
      border:1.5px solid var(--rule); border-radius:12px;
      padding:10px 14px; min-width:220px; font-weight:600;
      box-shadow:0 1px 0 rgba(9,30,66,.04);
    }
    .controls select{
      background-image: linear-gradient(45deg, transparent 50%, var(--ink) 50%),
                        linear-gradient(135deg, var(--ink) 50%, transparent 50%),
                        linear-gradient(to right, transparent, transparent);
      background-position: calc(100% - 18px) calc(1em - 2px),
                           calc(100% - 13px) calc(1em - 2px),
                           calc(100% - 2.5em) 0.5em;
      background-size: 6px 6px, 6px 6px, 1px 1.8em;
      background-repeat: no-repeat;
      padding-right: 2.6em; /* room for caret */
    }
    .controls select:focus, .controls input[type="search"]:focus{
      outline:2px solid var(--link); outline-offset:2px;
    }
    .btn{border:1px solid var(--accent); background:transparent; color:var(--ink); padding:8px 12px; border-radius:8px; cursor:pointer}
    .spacer{flex:1 1 auto}

    /* ----- Section headings & cards ----- */
    .section-title{
      margin:26px 0 8px; text-align:center;
      text-transform:uppercase; letter-spacing:.12em; color:var(--muted); font-weight:800; font-size:12px;
      border-top:1px solid var(--rule); padding-top:10px;
      scroll-margin-top: calc(var(--nav-h) + 72px); /* anchor offset under sticky bars */
    }
    .list{display:flex; flex-direction:column; gap:14px; margin-top:8px}
    .card{
      background:var(--panel); border:1px solid var(--rule); border-radius:12px; padding:16px;
      box-shadow:0 1px 0 rgba(9,30,66,.04), 0 10px 28px rgba(9,30,66,.06);
    }
    .title{font: 800 22px/1.25 "Newsreader", serif; margin:4px 0}
    .meta{color:var(--muted); font-size:12px}
    .sum{max-width:70ch} .sum p{margin:10px 0}
    body.skim .sum p{display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical; overflow:hidden}

    footer{color:var(--muted); font-size:12px; text-align:center; margin:18px 0 40px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Masthead -->
    <header class="mast">
      <div class="inner">
        <div class="left">
          <button class="icon-btn" id="menuBtn" aria-label="Menu">‚â°</button>
        </div>
        <h1 class="brand"><a href="#top">{{ header }}</a></h1>
        <div class="right">
          <button class="icon-btn" id="searchBtn" aria-label="Search">üîç</button>
          <a class="subscribe" href="{{ subscribe_url|default('#') }}" style="margin-left:8px">Subscribe</a>
        </div>
      </div>
    </header>

    <!-- Category navigation (anchors to sections) -->
    <nav class="cats" style="--nav-h:54px;">
      <div class="row" id="catRow">
        {% for s in sections_nav %}
          <a href="#{{ s.id }}" data-sec="{{ s.id }}">{{ s.title }}</a>
        {% endfor %}
      </div>
    </nav>

    <!-- Filters -->
    <div id="filters" class="controls" role="region" aria-label="Filters">
      <input id="q" type="search" placeholder="Search title & summary‚Ä¶" aria-label="Search articles" />
      <select id="source" aria-label="Filter by source"><option value="">All sources</option></select>
      <select id="section" aria-label="Filter by section"><option value="">All sections</option></select>
      <select id="sort" aria-label="Sort">
        <option value="rank">Section rank</option>
        <option value="date">Date (new‚Üíold)</option>
        <option value="score">Score</option>
      </select>
      <div class="spacer"></div>
      <button id="skim" class="btn" aria-pressed="false">Skim</button>
      <button id="theme" class="btn" aria-pressed="false">‚òæ/‚òÄÔ∏é</button>
    </div>

    {% block content %}{% endblock %}

    <footer>Generated {{ generated_at }} ‚Ä¢ Anchored section navigation</footer>
  </div>

  <script>
    // Theme toggle
    (function(){
      const root=document.documentElement,btn=document.getElementById('theme');
      if(!btn) return;
      const saved=localStorage.getItem('theme'); if(saved) root.setAttribute('data-theme',saved);
      btn.setAttribute('aria-pressed',(saved||'light')==='dark');
      btn.addEventListener('click',()=>{ const t=root.getAttribute('data-theme')||'light';
        const n=t==='dark'?'light':'dark'; root.setAttribute('data-theme',n);
        btn.setAttribute('aria-pressed', n==='dark'); localStorage.setItem('theme',n);});
    })();

    // Skim mode
    (function(){
      const b=document.body,btn=document.getElementById('skim');
      if(!btn) return;
      const saved=localStorage.getItem('skim')==='1'; if(saved){ b.classList.add('skim'); btn.setAttribute('aria-pressed','true');}
      btn.addEventListener('click',()=>{ b.classList.toggle('skim'); const on=b.classList.contains('skim'); btn.setAttribute('aria-pressed',on); localStorage.setItem('skim', on?'1':'0');});
    })();

    // Filters + search
    (function(){
      const $q=document.getElementById('q'),
            $src=document.getElementById('source'),
            $sec=document.getElementById('section'),
            $sort=document.getElementById('sort');
      const cards=[...document.querySelectorAll('.card')];

      // hydrate dropdowns (one-time)
      [...new Set(cards.map(c=>c.dataset.source))].sort()
        .forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;$src.appendChild(o);});
      [...new Set(cards.map(c=>c.dataset.section))].forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s.replace(/^\w/,x=>x.toUpperCase());$sec.appendChild(o);});

      function apply(){
        const q=($q?.value||'').toLowerCase().trim(),
              src=$src.value, sec=$sec.value, sort=$sort.value;

        // filter cards
        cards.forEach(c=>{
          const okQ=!q || c.dataset.haystack.includes(q);
          const okS=!src|| c.dataset.source===src;
          const okC=!sec|| c.dataset.section===sec;
          c.style.display=(okQ && okS && okC) ? '' : 'none';
        });

        // sort visible cards within each section list
        document.querySelectorAll('.sec-block .list').forEach(list=>{
          const vis=[...list.querySelectorAll('.card')].filter(c=>c.style.display!=='none');
          vis.sort((a,b)=> sort==='score'
                ? (parseFloat(b.dataset.score)-parseFloat(a.dataset.score))
                : sort==='date'
                  ? (b.dataset.date||'').localeCompare(a.dataset.date||'')
                  : (parseInt(a.dataset.rank,10)-parseInt(b.dataset.rank,10)));
          vis.forEach(el=>list.appendChild(el));
        });

        // hide section when it has no visible cards
        document.querySelectorAll('.sec-block').forEach(secBlock=>{
          const hasVisible=[...secBlock.querySelectorAll('.card')].some(c=>c.style.display!=='none');
          secBlock.style.display = hasVisible ? '' : 'none';
        });
      }

      [$q,$src,$sec,$sort].forEach(el=> el && el.addEventListener('input', apply));
      apply();
    })();

    // Scroll-spy: highlight active category as you scroll sections
    (function(){
      const links=[...document.querySelectorAll('.cats a')];
      if(!links.length) return;
      const map=new Map(links.map(a=>[a.dataset.sec, a]));
      const secs=[...document.querySelectorAll('h3.section-title')];
      const io=new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting){
            links.forEach(l=>l.classList.toggle('active', l.dataset.sec===e.target.id));
            history.replaceState(null,"", '#'+e.target.id);
          }
        });
      },{root: null, rootMargin:"-50% 0px -45% 0px", threshold:0});
      secs.forEach(s=>io.observe(s));
    })();

    // Search icon focuses search box
    (function(){
      const btn=document.getElementById('searchBtn'), q=document.getElementById('q');
      if(btn && q){ btn.addEventListener('click',()=>{ q.scrollIntoView({behavior:'smooth', block:'center'}); setTimeout(()=>q.focus(),400); }); }
    })();
  </script>
</body>
</html>
